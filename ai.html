<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>J.A.R.V.I.S</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --glow:#00f2ff;
  --bg:#000d11;
  --glass:rgba(0,242,255,.12);
}

body{
  margin:0;
  height:100vh;
  background:var(--bg);
  color:var(--glow);
  font-family:Courier New, monospace;
  display:flex;
  flex-direction:column;
  padding:10px;
}

/* CHAT AREA */
#chat{
  flex:1;
  background:var(--glass);
  border-radius:10px;
  padding:10px;
  overflow-y:auto;
  margin-bottom:10px;
}

/* MESSAGES */
.msg{margin-bottom:8px;}
.user{color:#fff;}
.jarvis{color:var(--glow);}
.system{color:#777;font-style:italic}

/* CONTROLS */
.controls{
  display:flex;
  gap:6px;
}

input{
  flex:1;
  background:transparent;
  border:1px solid var(--glow);
  border-radius:6px;
  color:#fff;
  padding:6px;
  outline:none;
}

button{
  background:none;
  border:1px solid var(--glow);
  color:var(--glow);
  border-radius:6px;
  font-size:18px;
  padding:4px 8px;
}

/* CAMERA */
video{
  display:none;
  width:100%;
  border-radius:10px;
}
</style>
</head>

<body>

<div id="chat">
  <div class="msg jarvis">Systems online. Awaiting your command, Sir.</div>
</div>

<div class="controls">
  <button onclick="startVoice()">üéôÔ∏è</button>
  <input id="input" placeholder="Type command">
  <button onclick="startCamera()">üì∑</button>
  <button onclick="send()">‚û§</button>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" hidden></canvas>

<script>
/* ================= CONFIG ================= */
const GEMINI_KEY = "AIzaSyBZRyrS8wtbnYz6j_edg8eqsNtKMSkyT38";
/* ========================================= */

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const video = document.getElementById("video");

function log(cls,text){
  chat.innerHTML += `<div class="msg ${cls}">${text}</div>`;
  chat.scrollTop = chat.scrollHeight;
}

function speak(text){
  speechSynthesis.cancel(); // FIX overlap
  log("jarvis", text);
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.95;
  u.pitch = 0.9;
  speechSynthesis.speak(u);
}

/* ================= GEMINI TEXT ================= */
async function askGemini(prompt){
  try{
    const r = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`,
      {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          contents:[{
            parts:[{
              text:`You are JARVIS. Calm, intelligent, British tone. Call the user Sir.\n\n${prompt}`
            }]
          }]
        })
      }
    );

    const d = await r.json();
    return d.candidates?.[0]?.content?.parts?.[0]?.text 
      || "No response received, Sir.";
  }catch(e){
    return "Sir, my systems are temporarily unavailable.";
  }
}

/* ================= SEND ================= */
async function send(){
  if(!input.value.trim()) return;
  const q = input.value;
  input.value = "";
  log("user", q);
  log("system", "Processing‚Ä¶");
  speak(await askGemini(q));
}

/* ================= VOICE ================= */
function startVoice(){
  if(!("webkitSpeechRecognition" in window)) {
    speak("Voice recognition not supported, Sir.");
    return;
  }
  const r = new webkitSpeechRecognition();
  r.lang = "en-US";
  r.onresult = e=>{
    input.value = e.results[0][0].transcript;
    send();
  };
  r.start();
}

/* ================= CAMERA ================= */
async function startCamera(){
  try{
    video.style.display = "block";
    const stream = await navigator.mediaDevices.getUserMedia({ video:true });
    video.srcObject = stream;

    setTimeout(async ()=>{
      const c = document.getElementById("canvas");
      c.width = video.videoWidth;
      c.height = video.videoHeight;
      c.getContext("2d").drawImage(video,0,0);
      const img = c.toDataURL("image/jpeg").split(",")[1];

      stream.getTracks().forEach(t=>t.stop());
      video.style.display = "none";

      const r = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`,
        {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({
            contents:[{
              parts:[
                { text:"Describe what you see like JARVIS." },
                { inline_data:{ mime_type:"image/jpeg", data:img } }
              ]
            }]
          })
        }
      );

      const d = await r.json();
      speak(d.candidates[0].content.parts[0].text);

    },2500);
  }catch{
    speak("Optical scan failed, Sir.");
  }
}
</script>

</body>
</html>